<div class="workout-detail-container">
  @if (currentPlan(); as plan) {
  <!-- Header -->
  <header class="page-header">
    <div class="header-left">
      <button class="btn-back" (click)="goBack()" title="Zur√ºck zur √úbersicht">
        <span class="material-icons">arrow_back</span>
        <span class="back-text">Zur√ºck</span>
      </button>
      <div class="plan-title">
        <h1>{{ plan.name }}</h1>
      </div>
      <div class="header-actions-mobile">
        <button class="btn-icon" (click)="showEditPlan()" title="Plan bearbeiten">
          <span class="material-icons">edit</span>
        </button>
        <button class="btn-icon btn-primary-icon" (click)="showCreateExercise()"
          [disabled]="showCreateExerciseForm() || editingExercise()" title="√úbung hinzuf√ºgen">
          <span class="material-icons">add</span>
        </button>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="showEditPlan()">
        <span class="material-icons">edit</span>
        Plan bearbeiten
      </button>
      <button class="btn btn-primary" (click)="showCreateExercise()"
        [disabled]="showCreateExerciseForm() || editingExercise()">
        <span class="material-icons">add</span>
        √úbung hinzuf√ºgen
      </button>
    </div>
  </header>

  <!-- Plan Edit Form -->
  @if (showEditPlanForm()) {
  <div class="form-overlay">
    <div class="form-container">
      <div class="form-header">
        <h2>Trainingsplan bearbeiten</h2>
        <button class="btn-close" (click)="hideEditPlan()">√ó</button>
      </div>
      <form (ngSubmit)="savePlan()" #editPlanForm="ngForm">
        <div class="form-body">
          <div class="form-group">
            <label for="editPlanName">Name des Trainingsplans *</label>
            <input type="text" id="editPlanName" [(ngModel)]="editPlanName" (ngModelChange)="editPlanName.set($event)"
              name="editPlanName" class="form-control" required maxlength="100">
          </div>
          <div class="form-group">
            <label for="editPlanDescription">Beschreibung</label>
            <textarea id="editPlanDescription" [(ngModel)]="editPlanDescription"
              (ngModelChange)="editPlanDescription.set($event)" name="editPlanDescription" class="form-control" rows="3"
              maxlength="500"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="hideEditPlan()">
            Abbrechen
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!editPlanName().trim()">
            Speichern
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Exercise Create/Edit Form -->
  @if (showCreateExerciseForm() || editingExercise()) {
  <div class="form-overlay">
    <div class="form-container exercise-form">
      <div class="form-header">
        <h2>{{ editingExercise() ? '√úbung bearbeiten' : 'Neue √úbung erstellen' }}</h2>
        <button class="btn-close" (click)="editingExercise() ? cancelEditExercise() : hideCreateExercise()">√ó</button>
      </div>
      <form (ngSubmit)="editingExercise() ? saveExercise() : createExercise()" #exerciseForm="ngForm">
        <div class="form-body">
          <div class="form-group">
            <label for="exerciseName">√úbungsname *</label>
            <input type="text" id="exerciseName" [(ngModel)]="newExerciseName"
              (ngModelChange)="newExerciseName.set($event)" name="exerciseName" class="form-control"
              placeholder="z.B. Bankdr√ºcken" required maxlength="100">
          </div>
          <div class="form-group">
            <label for="exerciseRestTime">Pause (Sekunden)</label>
            <input type="number" id="exerciseRestTime" [(ngModel)]="newExerciseRestTime"
              (ngModelChange)="newExerciseRestTime.set($event)" name="exerciseRestTime" class="form-control" min="0"
              max="600">
          </div>
          <div class="form-group">
            <label for="exerciseNotes">Notizen (optional)</label>
            <textarea id="exerciseNotes" [(ngModel)]="newExerciseNotes" (ngModelChange)="newExerciseNotes.set($event)"
              name="exerciseNotes" class="form-control" rows="3"
              placeholder="z.B. Langsam absenken, volle Bewegungsamplitude..." maxlength="300"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary"
            (click)="editingExercise() ? cancelEditExercise() : hideCreateExercise()">
            Abbrechen
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!newExerciseName().trim()">
            {{ editingExercise() ? 'Speichern' : 'Erstellen' }}
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Exercises List -->
  <div class="exercises-section">
    <h2>√úbungen ({{ plan.exercises.length }})</h2>

    @if (plan.exercises.length === 0) {
    <div class="empty-state">
      <div class="empty-icon">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
      <h3>Noch keine √úbungen hinzugef√ºgt</h3>
      <p>F√ºgen Sie Ihre erste √úbung hinzu, um mit dem Training zu beginnen!</p>
      <button class="btn btn-primary" (click)="showCreateExercise()">
        Erste √úbung hinzuf√ºgen
      </button>
    </div>
    } @else {
    <div class="exercises-list">
      @for (exercise of plan.exercises; track exercise.id; let i = $index) {
      <div class="exercise-card" [class.editing]="editingExercise()?.id === exercise.id">
        <div class="exercise-header" [class.single-line]="isExerciseNameSingleLine(exercise.name)">
          <div class="exercise-number">{{ i + 1 }}</div>
          <div class="exercise-title">
            <h3>{{ exercise.name }}</h3>
          </div>
          <div class="exercise-actions">
            <button class="btn-action" (click)="duplicateExercise(exercise)" title="Duplizieren">
              <span class="material-icons">content_copy</span>
            </button>
            <button class="btn-action" (click)="startEditExercise(exercise)" title="Bearbeiten"
              [disabled]="editingExercise() !== null">
              <span class="material-icons">edit</span>
            </button>
            <button class="btn-action danger" (click)="deleteExercise(exercise.id, exercise.name)" title="L√∂schen">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>

        @if (exercise.notes) {
        <div class="exercise-notes-section">
          <p class="exercise-notes">{{ exercise.notes }}</p>
        </div>
        }

        <div class="exercise-details">
          <!-- Dynamische S√§tze-Ansicht -->
          <div class="sets-simple">
            <div class="sets-grid">
              @for (set of exercise.sets; track set.id; let setIndex = $index; let isLast = $last) {
              <div class="set-row">
                @if (exercise.sets.length > 1 && isLast) {
                <button class="btn-action" (click)="removeLastSet(exercise)" title="Letzten Satz entfernen">
                  <span class="material-icons">remove</span>
                </button>
                }

                <div class="set-inputs-center">
                  <input type="number" [(ngModel)]="set.reps"
                    (ngModelChange)="updateSet(exercise, set.id, 'reps', $event)" class="set-input-simple"
                    placeholder="Wdh" min="1" max="100">
                  x
                  <input type="number" [(ngModel)]="set.weight"
                    (ngModelChange)="updateSet(exercise, set.id, 'weight', $event)" class="set-input-simple"
                    placeholder="kg" min="0" step="0.5">
                  <span class="set-unit">kg</span>
                </div>

                @if (isLast) {
                <button class="btn-action" (click)="addSet(exercise)" title="Satz hinzuf√ºgen">
                  <span class="material-icons">add</span>
                </button>
                }
              </div>
              }
            </div>
          </div>
        </div>

        <div class="exercise-meta">
          <small>Erstellt: {{ formatDate(exercise.createdAt) }}</small>
          @if (exercise.updatedAt.getTime() !== exercise.createdAt.getTime()) {
          <small>Bearbeitet: {{ formatDate(exercise.updatedAt) }}</small>
          }
        </div>
      </div>
      }
    </div>
    }
  </div>
  } @else {
  <!-- Loading oder Fehler -->
  <div class="empty-state">
    <div class="empty-icon">‚ùå</div>
    <h3>Trainingsplan nicht gefunden</h3>
    <p>Der angeforderte Trainingsplan existiert nicht oder wurde gel√∂scht.</p>
    <button class="btn btn-primary" (click)="goBack()">
      Zur√ºck zur √úbersicht
    </button>
  </div>
  }
</div>